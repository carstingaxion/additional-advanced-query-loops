var cql;(()=>{"use strict";var e={d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{CQL:()=>P,CQLControls:()=>i,CQLControlsInheritedQuery:()=>p});const r=window.wp.blocks,o=window.wp.i18n,l=window.React,u=window.wp.hooks,n=window.wp.blockEditor,a=window.wp.components,{Fill:c,Slot:y}=(0,a.createSlotFill)("CQLControls"),q=({children:e})=>(0,l.createElement)(c,null,e);q.Slot=({fillProps:e})=>(0,l.createElement)(y,{fillProps:e},(e=>e.length?e:null));const i=q,{Fill:s,Slot:d}=(0,a.createSlotFill)("CQLControlsInheritedQuery"),x=({children:e})=>(0,l.createElement)(s,null,e);x.Slot=d;const p=x,m=({attributes:e,setAttributes:t})=>{const{query:{order:r,orderBy:u}={}}=e;return(0,l.createElement)(l.Fragment,null,(0,l.createElement)(a.SelectControl,{label:(0,o.__)("Post Order By","contextual-query-loop"),value:u,help:"meta_value"===u||"meta_value_num"===u?(0,o.__)("Meta Value and Meta Value Num require that Meta Key is set in the Meta Query section.","contextual-query-loop"):"",options:[{label:(0,o.__)("Author","contextual-query-loop"),value:"author"},{label:(0,o.__)("Date","contextual-query-loop"),value:"date"},{label:(0,o.__)("Last Modified Date","contextual-query-loop"),value:"modified"},{label:(0,o.__)("Title","contextual-query-loop"),value:"title"},{label:(0,o.__)("Random","contextual-query-loop"),value:"rand"},{label:(0,o.__)("Menu Order","contextual-query-loop"),value:"menu_order"},{label:(0,o.__)("Post ID","contextual-query-loop"),value:"id"}],onChange:r=>{t({query:{...e.query,orderBy:r}})}}),(0,l.createElement)(a.ToggleControl,{label:(0,o.__)("Ascending Order","contextual-query-loop"),checked:"asc"===r,onChange:()=>{t({query:{...e.query,order:"asc"===r?"desc":"asc"}})}}))},_=window.wp.data,h=window.wp.coreData,b=({attributes:e,setAttributes:t,context:r})=>{const{query:u}=e,{query:{postType:n,querycontext:c}={}}=e,y=r=>{if(e.query.querycontext&&e.query.querycontext.author&&1===r)return delete e.query.querycontext.author,void t({query:{...e.query,querycontext:{...e.query.querycontext}}});t({query:{...e.query,querycontext:{...e.query.querycontext,author:r}}})};if((0,_.useSelect)((e=>!!n&&!!e(h.store).getPostType(n)?.supports.author)))return(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null," ",(0,o.__)("Contextual Author","contextual-query-loop")),(0,l.createElement)(a.ToggleControl,{label:(0,o.__)("Contextual Author","contextual-query-loop"),help:"Include posts by the same author as the context post.",checked:c&&c.author,onChange:()=>y(1),disabled:c&&c.user}),(0,l.createElement)(a.ToggleControl,{label:(0,o.__)("Exclude contextual Author","contextual-query-loop"),help:"Include posts by different authors as author of the context post.",checked:c&&c.author&&-1===c.author,onChange:()=>y(-1),disabled:c&&c.user}),(0,l.createElement)(a.ToggleControl,{label:(0,o.__)("Contextual User","contextual-query-loop"),help:"Include posts by the currently logged-in user.",checked:c&&c.user,onChange:()=>{if(e.query.querycontext&&e.query.querycontext.user)return delete e.query.querycontext.user,void t({query:{...e.query,querycontext:{...e.query.querycontext}}});delete e.query.querycontext.author,t({query:{...e.query,querycontext:{...e.query.querycontext,user:1}}})}}))},g={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let E;const f=new Uint8Array(16);function v(){if(!E&&(E="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!E))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return E(f)}const C=[];for(let e=0;e<256;++e)C.push((e+256).toString(16).slice(1));const w=function(e,t,r){if(g.randomUUID&&!t&&!e)return g.randomUUID();const o=(e=e||{}).random||(e.rng||v)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=o[e];return t}return function(e,t=0){return C[e[t+0]]+C[e[t+1]]+C[e[t+2]]+C[e[t+3]]+"-"+C[e[t+4]]+C[e[t+5]]+"-"+C[e[t+6]]+C[e[t+7]]+"-"+C[e[t+8]]+C[e[t+9]]+"-"+C[e[t+10]]+C[e[t+11]]+C[e[t+12]]+C[e[t+13]]+C[e[t+14]]+C[e[t+15]]}(o)},S=window.wp.element,k=["IN","NOT IN","AND","EXISTS","NOT EXISTS"],T=({registeredTaxKeys:e,id:t,queries:r,attributes:u,setAttributes:n})=>{const c=r.find((e=>e.id===t)),y=(e,t,r,o)=>e.map((e=>e.id===t?{...e,[r]:o}:e)),q=Object.values(e);return(0,l.createElement)(l.Fragment,null,(0,l.createElement)(a.BaseControl,{help:(0,o.__)("Start typing to search for a taxonomy.","contextual-query-loop")},(0,l.createElement)(a.FormTokenField,{label:(0,o.__)("Tax Key","contextual-query-loop"),value:c?.tax_key?.length?[c.tax_key]:[],__experimentalShowHowTo:!1,suggestions:q,maxLength:1,onChange:o=>{var l,a=(l=o[0],Object.keys(e).find((t=>e[t]===l)));n({query:{...u.query,querycontext:{...u.query.querycontext,tax_query:{...u.query.querycontext.tax_query,queries:y(r,t,"tax_key",a)}}}})}})),(0,l.createElement)(a.SelectControl,{label:(0,o.__)("Tax Operator","contextual-query-loop"),value:c.tax_compare,options:[...k.map((e=>({label:e,value:e})))],onChange:e=>{n({query:{...u.query,querycontext:{...u.query.querycontext,tax_query:{...u.query.querycontext.tax_query,queries:y(r,t,"tax_compare",e)}}}})}}),(0,l.createElement)(a.Button,{isSmall:!0,variant:"secondary",isDestructive:!0,onClick:()=>{const e=r.filter((e=>e.id!==t));n({query:{...u.query,querycontext:{...u.query.querycontext,tax_query:{...u.query.querycontext.tax_query,queries:e}}}})}},(0,o.__)("Remove contextual tax query","contextual-query-loop")))},D=({attributes:e,setAttributes:t})=>{const{query:{postType:r,querycontext:{tax_query:{relation:u="",queries:n=[]}={}}={}}={}}=e,[c]=(0,S.useState)(r);(0,S.useEffect)((()=>{r!==c&&t({query:{...e.query,querycontext:{...e.query.querycontext,tax_query:{}}}})}),[r]);const y=(e=>{const t=(e=>{const t=(0,_.useSelect)((t=>{const{getTaxonomies:r}=t(h.store);return r({type:e,per_page:-1})}),[e]);return(0,S.useMemo)((()=>t?.filter((({visibility:e})=>!!e?.publicly_queryable))),[t])})(e);let r={};return t&&t.length>0&&(r=t.reduce(((e,{name:t,slug:r})=>(e[r]=t,e)),{})),{...r}})(r);if(!(Object.keys(y).length<1))return(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null,(0,o.__)("Context Tax Query","contextual-query-loop")),(0,l.createElement)(l.Fragment,null,n.length>1&&(0,l.createElement)(a.SelectControl,{label:(0,o.__)("Query Relationship","contextual-query-loop"),value:u,options:[{label:"Choose relationship",value:""},{label:"AND",value:"AND"},{label:"OR",value:"OR"}],onChange:r=>t({query:{...e.query,querycontext:{...e.query.querycontext,tax_query:{...e.query.querycontext.tax_query,relation:r}}}})}),n.length<1&&(0,l.createElement)("p",null,(0,o.__)("Add a tax query to select post tax to query","contextual-query-loop")),n.map((({id:r,tax_key:o,compare:u})=>(0,l.createElement)(a.PanelBody,{key:r},(0,l.createElement)(T,{id:r,taxKey:o,taxCompare:u,registeredTaxKeys:y,queries:n,attributes:e,setAttributes:t})))),(0,l.createElement)(a.Button,{isSmall:!0,variant:"primary",onClick:()=>{const r=[...n,{id:w(),tax_key:"",tax_compare:""}];t({query:{...e.query,querycontext:{...e.query.querycontext,tax_query:{...e.query.querycontext.tax_query,queries:r}}}})}},(0,o.__)("Add contextual tax query","contextual-query-loop"))))},A=({attributes:e,setAttributes:t})=>{const{query:{querycontext:{date_query:{relation:r="",date_primary:u="",date_primary_selected:n=null,modifier_primary:c="",date_secondary:y=new Date,inclusive:q=!1}={}}={}}={}}=e;if(e.query&&e.query?.querycontext)return(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null,(0,o.__)("Context Date Query","contextual-query-loop")),(0,l.createElement)(a.SelectControl,{label:(0,o.__)("Date Relationship","contextual-query-loop"),value:r,options:[{label:"None",value:""},{label:"Exact",value:"exact"},{label:"Before",value:"before"},{label:"After",value:"after"}],onChange:r=>{if(""===r)return delete e.query.querycontext.date_query,void t({query:{...e.query,querycontext:{...e.query.querycontext}}});t({query:{...e.query,querycontext:{...e.query.querycontext,date_query:{...e.query.querycontext.date_query,relation:r}}}})}}),""!==r&&(0,l.createElement)(l.Fragment,null,(0,l.createElement)(a.RadioControl,{label:(0,o.__)("Start date","contextual-query-loop"),help:(0,o.__)('Every date relates to its contextual post. Except "today", which relates to context of the viewer (human or cache-engine ;).',"contextual-query-loop"),selected:u,options:[{label:"today",value:"today"},{label:"published day",value:"post_day"},{label:"published date",value:"post_date"},{label:"published month",value:"post_month"},{label:"published year",value:"post_year"},{label:"last modified date",value:"modified_date"},{label:"last modified month",value:"modified_month"},{label:"last modified year",value:"modified_year"},{label:"select a Date",value:"selected_date"}],onChange:r=>{t({query:{...e.query,querycontext:{...e.query.querycontext,date_query:{...e.query.querycontext.date_query,date_primary:r}}}})}}),"selected_date"===u&&(0,l.createElement)("div",null,(0,l.createElement)(a.DatePicker,{currentDate:n,startOfWeek:1,onChange:r=>{t({query:{...e.query,querycontext:{...e.query.querycontext,date_query:{...e.query.querycontext.date_query,date_primary_selected:r}}}})}})),(0,l.createElement)(a.__experimentalUnitControl,{isResetValueOnUnitChange:!0,label:(0,o.__)("Date modifier","contextual-query-loop"),labelPosition:"side",help:"Modify the date to be earlier (-) or later (+) to the contextualised date selected above.",onChange:r=>{t({query:{...e.query,querycontext:{...e.query.querycontext,date_query:{...e.query.querycontext.date_query,modifier_primary:r}}}})},units:[{default:-1,label:"Day",value:"day"},{default:-1,label:"Week",value:"week"},{default:-1,label:"Month",value:"month"},{default:-1,label:"Year",value:"year"}],value:c}),"between"===r&&(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h4",null,(0,o.__)("End date","contextual-query-loop")),(0,l.createElement)(a.DatePicker,{currentDate:y,onChange:r=>{t({query:{...e.query,querycontext:{...e.query.querycontext,date_query:{...e.query.querycontext.date_query,date_secondary:r}}}})}})),"between"===r&&(0,l.createElement)(l.Fragment,null,(0,l.createElement)("br",null),(0,l.createElement)(a.CheckboxControl,{label:(0,o.__)("Include selected date(s)","contextual-query-loop"),help:(0,o.__)("Should the selected date(s) be included in your query?","contextual-query-loop"),checked:q,onChange:r=>{t({query:{...e.query,querycontext:{...e.query.querycontext,date_query:{...e.query.querycontext.date_query,inclusive:r}}}})}}))))},F=({attributes:e,setAttributes:t})=>{const{query:{querycontext:{exclude_current:r}={}}={}}=e;return(0,l.createElement)(l.Fragment,null,(0,l.createElement)("h2",null," ",(0,o.__)("Exclude Posts","contextual-query-loop")),(0,l.createElement)(a.ToggleControl,{label:(0,o.__)("Exclude Contextual Post","contextual-query-loop"),checked:!!r,onChange:()=>{if(e.query.querycontext&&e.query.querycontext.exclude_current)return delete e.query.querycontext.exclude_current,void t({query:{...e.query,querycontext:{...e.query.querycontext}}});t({query:{...e.query,querycontext:{...e.query.querycontext,exclude_current:1}}})}}))};(0,u.addFilter)("editor.BlockEdit","core/query",(e=>t=>{if((e=>{const{attributes:{namespace:t}}=e;return t&&t===P})(t)){const{attributes:r}=t;return!1===r.query.inherit?(0,l.createElement)(l.Fragment,null,(0,l.createElement)(n.InspectorControls,null,(0,l.createElement)(a.PanelBody,{title:(0,o.__)("Contextual Settings","contextual-query-loop")},(0,l.createElement)(F,{...t}),(0,l.createElement)(A,{...t}),(0,l.createElement)(D,{...t}),(0,l.createElement)(b,{...t}),(0,l.createElement)(m,{...t}),(0,l.createElement)(i.Slot,{fillProps:{...t}}))),(0,l.createElement)(e,{...t})):(0,l.createElement)(l.Fragment,null,(0,l.createElement)(e,{...t}),(0,l.createElement)(n.InspectorControls,null,(0,l.createElement)(a.PanelBody,{title:(0,o.__)("Contextual Settings","contextual-query-loop")},(0,l.createElement)(m,{...t}),(0,l.createElement)(p.Slot,{fillProps:{...t}}))))}return(0,l.createElement)(e,{...t})}));const P="contextual-query-loop",I={name:P,title:(0,o.__)("Contextual Query Loop","contextual-query-loop"),description:(0,o.__)("Query loop block-variation to create custom queries based on the post- or template-context.","contextual-query-loop"),icon:function(){return(0,l.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 221.3 111.6"},(0,l.createElement)("text",{fill:"#e76f51",fontFamily:"Montserrat-Bold, Montserrat",fontSize:"100",transform:"translate(.9 85)"},(0,l.createElement)("tspan",{x:"0",y:"0",letterSpacing:"0em"},"C"),(0,l.createElement)("tspan",{x:"75.6",y:"0",letterSpacing:"0em"},"QL")))},isActive:(e,t)=>!(!e.namespace||P!==e.namespace||(e.query.querycontext&&e.query.querycontext.author&&console.log('We should (be able to) disable the default-author controll at this point, while "contextual-author" is selected.'),0)),attributes:{namespace:P,querycontext:[]},scope:["inserter","transform"],allowedControls:["postType","sticky","taxQuery","author","search"]};(0,r.registerBlockVariation)("core/query",{...I}),cql=t})();